<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Лабораторная работа 05</title>
</head>
<body>
<div class="container">
    <h1>Управление записями БД</h1>
    <button class="btn-select" onclick="select()">Получить все данные</button>
    <div id="select_result"></div>
    <div id="error"></div>

    <div class="form-section">
        <h2>Добавить запись</h2>
        <div class="row">
            <label for="IDinsert">ID</label>
            <input type="number" id="IDinsert" min="0" required />
        </div>
        <div class="row">
            <label for="NameInsert">Имя</label>
            <input type="text" id="NameInsert" required />
        </div>
        <div class="row">
            <label for="BdayInsert">День рождения</label>
            <input type="date" id="BdayInsert" required />
        </div>
        <button class="btn-add" onclick="insert()">Добавить</button>
    </div>

    <div class="form-section">
        <h2>Обновить запись</h2>
        <div class="row">
            <label for="IDupdate">ID</label>
            <input type="number" id="IDupdate" min="0" required onchange="getPersonById()" />
        </div>
        <div class="row">
            <label for="NameUpdate">Имя</label>
            <input type="text" id="NameUpdate" required />
        </div>
        <div class="row">
            <label for="BdayUpdate">День рождения</label>
            <input type="date" id="BdayUpdate" required />
        </div>
        <button class="btn-update" onclick="update()">Обновить по ID</button>
    </div>

    <div class="form-section">
        <h2>Удалить запись</h2>
        <div class="row">
            <label for="IDdelete">ID</label>
            <input type="number" id="IDdelete" min="0" required />
        </div>
        <button class="btn-delete" onclick="remove()">Удалить по ID</button>
    </div>

    <div class="form-section">
        <h2>Статистика</h2>
        <button class="btn-select" onclick="getStats()">Получить статистику</button>
        <div id="stats_result"></div>
    </div>
</div>
<script>
    const select = () => {
        fetch("/api/db", {method: "GET", headers: {'Accept': 'application/json'}})
            .then(response => response.json())
            .then(data => {
                select_result.innerHTML = "";
                if (data.length === 0) {
                    select_result.innerHTML = "<i>Нет данных</i>";
                    return;
                }
                data.forEach(el => select_result.innerHTML += `${el.id}. ${el.name} — ${el.bday}<br>`);
            })
            .catch(err => error.innerHTML = "Ошибка загрузки данных: " + err);
    };

    const insert = () => {
        error.innerHTML = "";
        fetch("/api/db", {
            method: "POST",
            headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
            body: JSON.stringify({
                id: IDinsert.value,
                name: NameInsert.value,
                bday: checkDate(BdayInsert.value),
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    error.innerHTML = data.error;
                } else {
                    select(); 
                    IDinsert.value = "";
                    NameInsert.value = "";
                    BdayInsert.value = "";
                }
            })
            .catch(err => error.innerHTML = "Ошибка добавления: " + err);
    };

    const update = () => {
        error.innerHTML = "";
        fetch("/api/db", {
            method: "PUT",
            headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
            body: JSON.stringify({
                id: IDupdate.value,
                name: NameUpdate.value,
                bday: checkDate(BdayUpdate.value),
            })
        })
            .then(response => response.json())
            .then(data => {
                    if (data.error) {
                        error.innerHTML = data.error;
                    } else {
                        select();
                            IDupdate.value = "";
                            NameUpdate.value = "";
                            BdayUpdate.value = "";
                    }
            })

            .catch(err => error.innerHTML = "Ошибка обновления: " + err);
    };

    const remove = () => {
        error.innerHTML = "";
        fetch(`/api/db?id=${IDdelete.value}`, {method: "DELETE", headers: {'Accept': 'application/json'}})
            .then(response => response.json())
            .then(data => {
                if (data.error) error.innerHTML = data.error;
                else select();
                IDdelete.value = "";
            })
            .catch(err => error.innerHTML = "Ошибка удаления: " + err);
    };

    const getPersonById = async () => {
        try {
            const people = await fetch("/api/db", {method: "GET", headers: {'Accept': 'application/json'}})
                .then(response => response.json());

            const current = people.find(p => p.id == IDupdate.value);
            if (current) {
                NameUpdate.value = current.name;
                BdayUpdate.value = current.bday.replace(/(\d{2})-(\d{2})-(\d{4})/, '$3-$2-$1');
            } else {
                error.innerHTML = "Нет человека с таким ID";
                IDupdate.value = NameUpdate.value = BdayUpdate.value = "";
            }
        } catch (err) {
            error.innerHTML = "Ошибка поиска: " + err;
        }
    };

    const getStats = () => {
    fetch("/api/ss", { method: "GET", headers: { 'Accept': 'application/json' } })
        .then(response => response.json())
        .then(data => {
            const formatDateTime = (dateString) => {
                if (!dateString) return 'Н/Д';
                const date = new Date(dateString);
                if (isNaN(date)) return dateString;

                const today = new Date();
                date.setHours(today.getHours(), today.getMinutes());

                return date.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            };
            
            stats_result.innerHTML = `
                <strong>Статистика:</strong><br>
                Начало: ${formatDateTime(data.start)}<br>
                Конец: ${data.finish ? formatDateTime(data.finish) : 'В процессе...'}<br>
                Кол-во запросов: ${data.request || 0}<br>
                Кол-во фиксаций: ${data.commit || 0}
                `;

            })
            .catch(err => {
                stats_result.innerHTML = "Ошибка получения статистики: " + err;
            });
        };

    const checkDate = date => date.replace(/(\d{4})-(\d{2})-(\d{2})/, '$3-$2-$1');
</script>
</body>
</html>